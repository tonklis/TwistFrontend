<script>
    
    // Obtenemos el xml del juego
    var backend_accion_oponente = 'pregunta';
    var backend_accion_oponente_data = '¿Tu personaje es una ardilla musculosa?';
    var xml = '<partida id="1" jugador1="574865437" jugador2="000000000" turno="574865437"><tablero tipo="personaje"><carta posicion="0" id="0" url="img/personajes/pilar.png" description="Pilar"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>cerrado</estatusJugador2></carta><carta posicion="1" id="1" url="img/personajes/david.png" description="David"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>abierto</estatusJugador2></carta><carta posicion="2" id="2" url="img/personajes/lentes.png" description="Lentes"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>cerrado</estatusJugador2></carta><carta posicion="3" id="3" url="img/personajes/seniora.png" description="Señora"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>cerrado</estatusJugador2></carta><carta posicion="4" id="4" url="img/personajes/jake.png" description="Jake"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>cerrado</estatusJugador2></carta><carta posicion="5" id="5" url="img/personajes/cesar.png" description="Cesar"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>abierto</estatusJugador2></carta><carta posicion="6" id="6" url="img/personajes/gaby.png" description="Gaby"><estatusJugador1>cerrado</estatusJugador1><estatusJugador2>cerrado</estatusJugador2></carta><carta posicion="7" id="7" url="img/personajes/mario.png" description="Mario"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>cerrado</estatusJugador2></carta><carta posicion="8" id="8" url="img/personajes/andy.png" description="andy"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>abierto</estatusJugador2></carta><carta posicion="9" id="9" url="img/personajes/niniocolor.png" description="Niño Color"><estatusJugador1>cerrado</estatusJugador1><estatusJugador2>cerrado</estatusJugador2></carta><carta posicion="10" id="10" url="img/personajes/marcela.png" description="Marcela"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>cerrado</estatusJugador2></carta><carta posicion="11" id="11" url="img/personajes/sarah.png" description="Sarah"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>abierto</estatusJugador2></carta><carta posicion="12" id="12" url="img/personajes/humberto.png" description="Humberto"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>cerrado</estatusJugador2></carta><carta posicion="13" id="13" url="img/personajes/bigote.png" description="Bigote"><estatusJugador1>cerrado</estatusJugador1><estatusJugador2>abierto</estatusJugador2></carta><carta posicion="14" id="14" url="img/personajes/hector.png" description="Hector"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>cerrado</estatusJugador2></carta><carta posicion="15" id="15" url="img/personajes/paco.png" description="Paco"><estatusJugador1>cerrado</estatusJugador1><estatusJugador2>cerrado</estatusJugador2></carta><carta posicion="16" id="16" url="img/personajes/alejandro.png" description="Alejandro"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>abierto</estatusJugador2></carta><carta posicion="17" id="17" url="img/personajes/arturo.png" description="Arturo"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>abierto</estatusJugador2></carta><carta posicion="18" id="18" url="img/personajes/roberto.png" description="Roberto"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>cerrado</estatusJugador2></carta><carta posicion="19" id="19" url="img/personajes/salvador.png" description="Salvador"><estatusJugador1>abierto</estatusJugador1><estatusJugador2>abierto</estatusJugador2></carta></tablero></partida>';
    
    var xmlDoc = $.parseXML(xml);
    var xml = $(xmlDoc);
    
    var miTurno = getMiTurno();
    var noJugador = getNoJugador();
    
    // Desplegamos los botones dependiendo de a quien le toca jugar
    muestraBotones();
    
    // Desplegamos el tablero generado
    muestraTablero();
    
    // Desplegamos el mensaje inicial
    muestraMensajeInicial();
    
    // Asignamos la funcionalidad de flip cuando se hace click
    seleccionarAccionClick('flip');
    
    function getMiTurno() {        
        if (getCache('usuario').facebook_id == xml.find('partida').attr('turno')) {
            return true;
        } else {
            return false;
        }
    }
    
    function getNoJugador() {
        if (getCache('usuario').facebook_id == xml.find('partida').attr('jugador1')) {
            return 1;
        } else {
            return 2;
        }
    }
    
    function muestraBotones() {
        var mnu_botones = '';
        
        mnu_botones = mnu_botones + '<img id="juego_preguntas" src="img/ju_preguntas.png" />';
        
        if (miTurno){
            mnu_botones = mnu_botones + '<img id="btn_juego_adivinar" src="img/ju_btn_adivinar.png" onclick="adivinar();"/><img id="btn_juego_preguntar" src="img/ju_btn_preguntar.png" onclick="preguntar();"/>';
        }
        
        mnu_botones = mnu_botones + '<img id="btn_juego_salir" src="img/btn_salir.png" onclick="inicio();" />';
        
        $('#mnu_botones').html(mnu_botones);
        
    }
    
    function muestraTablero() {
        var cuadro_negro = '';
        for (var i = 0; i < 20; i++) {
            var carta = xml.find('carta[posicion=' + i + ']');
            var estatusCarta = carta.find('estatusJugador' + noJugador).text();
            var clasesCarta = 'panel ';
            
            if (miTurno) {
                clasesCarta = clasesCarta + 'click ';
            }
            switch(estatusCarta) {
                case 'cerrado':
                    clasesCarta = clasesCarta + 'flip';
                    break;
                case 'bloqueado':
                    break;
                default:
                    break;
            }
            
            var objeto = {}
            objeto.id = carta.attr('id');
            objeto.description = carta.attr('description');
            objeto.url = carta.attr('url');
            cuadro_negro += obtieneCarta(objeto, i, '', clasesCarta);
        }
        
        $('#cuadro_negro').html(cuadro_negro);
        loaderCartas();
    }
    
    function muestraMensajeInicial() {
        if (miTurno) {
            if(backend_accion_oponente == 'pregunta'){
                alert(backend_accion_oponente_data,
                      ALERTA_SI_NO,
                      {
                      'btn_si' : cancela,
                      'btn_no' : cancela
                      });
            } else {
                alert(backend_accion_oponente_data,
                      ALERTA_OK,
                      {
                      'btn_continuar' : cancela
                      });
            }
            
        } else {
            alert('Actualmente es el turno de tu oponente',
                  ALERTA_OK,
                  {
                  'btn_continuar' : cancela
                  });
        }
    }
    
    function seleccionarAccionClick(accion) {
        audioCardFlip = createAudio('card_flip');
        
        if(accion == 'seleccion'){
            
            $('.click').unbind('click');
            $('.click').click(function(){
                              audioCardFlip.play();
                              alert($(this).attr('posicion'));
                        });
            
        } else if(accion == 'flip'){
            
            $('.click').unbind('click');
            $('.click').click(function(){
                              audioCardFlip.play();
                              
                              var posicion = $(this).attr('posicion');
                              var carta = xml.find('carta[posicion=' + posicion + ']');
                              var estatusCarta = carta.find('estatusJugador' + noJugador).text();
                              
                              if(estatusCarta == 'abierto') {
                                    carta.find('estatusJugador' + noJugador).text('cerrado');
                              } else if(estatusCarta == 'cerrado'){
                                    carta.find('estatusJugador' + noJugador).text('abierto');
                              }
                              
                              if($(this).hasClass('flip')) {
                                $(this).removeClass('flip');
                              } else {
                                $(this).addClass('flip');
                              }
                        });
        }
    }
    
    
    function adivinar(){
        seleccionarAccionClick('seleccion');
        $('#btn_juego_adivinar').attr('src','img/btn_continuar.png');
        $('#btn_juego_adivinar').attr('onclick','cancelarAdivinar();');
    }
    
    function cancelarAdivinar(){
        seleccionarAccionClick('flip');
        $('#btn_juego_adivinar').attr('src','img/ju_btn_adivinar.png');
        $('#btn_juego_adivinar').attr('onclick','adivinar();');
    }
    
    function preguntar() {
		alert('Introduce tu pregunta:',
              ALERTA_INPUT,
              {
              'btn_enviar' : enviaTablero
              });
	}
    
    function enviaTablero(){
        navigator.notification.alert('Estoy enviando el tablero: ' + (new XMLSerializer()).serializeToString(xmlDoc));
    }
	
	function cancela() {
        
	}
    
</script>
<div id="juego">
	<div class="izquierda">
		<div id="menu">
            <div id="mnu_carta"></div>
            <div id="mnu_botones">
			</div>
		</div>
	</div>
	<div class="derecha">
		<div id="cuadro_negro">
		</div>
	</div>
</div>