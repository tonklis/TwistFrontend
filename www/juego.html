<script>
	$('#loading').show();
	
    // Obtenemos el xml del juego
    var juego = getCache('juego');
    
    var xmlDoc = $.parseXML(juego.board.detail_xml);
    var xml = $(xmlDoc);
    
    var miTarjeta = juego.card_id;
    var totalPreguntas = juego.question_count;
    var ultimaAccion = ACCION_NUEVO;
    
    var miTurno = getMiTurno();
    var noJugador = getNoJugador();
    
    // Desplegamos los botones dependiendo de a quien le toca jugar
    $('#total_preguntas').html(totalPreguntas + ' / 5');
    muestraBotones();
    
    // Desplegamos el tablero generado
    muestraTablero();
    
    // Desplegamos el mensaje inicial
    muestraMensajeInicial();
    
    // Asignamos la funcionalidad de flip cuando se hace click
    seleccionarAccionClick('flip');
    
    function getMiTurno() {
        if (getCache('usuario').id == juego.board.last_action) {
            return false;
        } else {
            return true;
        }
    }
    
    function getNoJugador() {
        if (getCache('usuario').facebook_id == xml.find('partida').attr('jugador1')) {
            return 1;
        } else {
            return 2;
        }
    }
    
    function muestraBotones() {
        var mnu_botones = '';
        if (miTurno && miTarjeta !== null) {
            mnu_botones += '<img id="btn_juego_adivinar" src="img/ju_btn_adivinar.png" onclick="adivinar();"/><img id="btn_juego_preguntar" src="img/ju_btn_preguntar.png" onclick="preguntar();"/>';
        } else if (miTurno) {
            mnu_botones += '<img id="btn_juego_continuar" src="img/btn_continuar.png" onclick="aceptarPartida();"/>';
        }
        mnu_botones += '<img id="btn_juego_salir" src="img/btn_salir.png" onclick="inicio();" />';
        $('#mnu_botones').html(mnu_botones);
    }
    
    function muestraTablero() {
        var tablero = xml.find('tablero');
        var cartas = new Array();
        var posicion = -1;
        for (var i = 0; i < 20; i++) {
            var carta = xml.find('carta[posicion=' + i + ']');
            if (miTarjeta == carta.attr('id')) {
            	posicion = i;
            }
            
            var clasesCarta = 'panel ';
            if (miTurno) {
                clasesCarta = clasesCarta + 'click ';
            }
            var estatusCarta = carta.find('estatusJugador' + noJugador).text();
            switch(estatusCarta) {
                case 'cerrado':
                    clasesCarta = clasesCarta + 'flip ';
                    break;
                case 'bloqueado':
                    break;
                default:
                    break;
            }
            
            var objeto = {
            	id : carta.attr('id'),
            	description : carta.attr('nombre'),
            	url : decodeURIComponent(carta.attr('ruta')),
            	template_id : tablero.attr('tipo'),
            	clases : clasesCarta
            };
            cartas.push(objeto);
        }
        
        var cuadro_negro = '';
        for (var i = 0; i < cartas.length; i++) {
			var funcion = '';
			if (posicion == -1) {
				funcion = 'seleccionarPersonaje(' + i + ')';
			}
			cuadro_negro += obtieneCarta(cartas[i], i, funcion, cartas[i].clases);
        }
        
        $('#cuadro_negro').html(cuadro_negro);
        if (posicion >= 0) {
        	seleccionarPersonaje(posicion);
        } else {
        	$('#mnu_carta').html('<img class="instruccion" src="img/nu_selecciona_oponente.png"/>');
        }
        loaderCartas();
        $('#loading').hide();
    }
    
    function muestraMensajeInicial() {
        if (miTurno) {
            if (ultimaAccion == ACCION_NUEVO) {
            	alert('Es tu turno de preguntar o adivinar.');
            } else if (ultimaAccion == ACCION_PREGUNTA) {
                alert('PREGUNTA',
                      ALERTA_SI_NO,
                      {
                      'btn_si' : cancela,
                      'btn_no' : cancela
                      });
            } else if (ultimaAccion == ACCION_ADIVINA) {
                alert('Tu oponente intentó adivinar pero no adivinó tu personaje.');
            }
        } else {
            alert('Actualmente es el turno de tu oponente');
        }
    }
    
    function seleccionarAccionClick(accion) {
    	if (accion == 'seleccion') {
    		$('.click').unbind('click');
    		$('.click').click(
    			function() {
    				playAudio('flip');
    				alert($(this).attr('posicion'));
    			});
    	} else if (accion == 'flip') {
    		$('.click').unbind('click');
    		$('.click').click(
    			function() {
    				playAudio('flip');
    				
    				var posicion = $(this).attr('posicion');
    				var carta = xml.find('carta[posicion=' + posicion + ']');
    				var estatusCarta = carta.find('estatusJugador' + noJugador).text();
    				
    				if (estatusCarta == 'abierto') {
    					carta.find('estatusJugador' + noJugador).text('cerrado');
    				} else if(estatusCarta == 'cerrado') {
    					carta.find('estatusJugador' + noJugador).text('abierto');
    				}
    				
    				if ($(this).hasClass('flip')) {
    					$(this).removeClass('flip');
    				} else {
    					$(this).addClass('flip');
    				}
    			});
    	}
    }
    
    function adivinar(){
        seleccionarAccionClick('seleccion');
        $('#btn_juego_adivinar').attr('src','img/btn_continuar.png');
        $('#btn_juego_adivinar').attr('onclick','cancelarAdivinar();');
    }
    
    function cancelarAdivinar(){
        seleccionarAccionClick('flip');
        $('#btn_juego_adivinar').attr('src','img/ju_btn_adivinar.png');
        $('#btn_juego_adivinar').attr('onclick','adivinar();');
    }
    
    function preguntar() {
		alert('Introduce tu pregunta:',
              ALERTA_INPUT,
              {
              'btn_enviar' : enviaTablero
              });
	}
    
    function enviaTablero() {
        navigator.notification.alert('Estoy enviando el tablero: ' + (new XMLSerializer()).serializeToString(xmlDoc));
    }
	
	function cancela() {
        
	}
	
	
	/* Funciones para aceptar un juego */
	var posicionSeleccionada = null;
	
	function seleccionarPersonaje(posicion) {
        if (posicionSeleccionada != null) {
        	$('.cartaTablero[posicion="' + posicionSeleccionada + '"]').removeClass('cartaSeleccionada');
        }
        $('.cartaTablero[posicion="' + posicion + '"]').addClass('cartaSeleccionada');
        
        posicionSeleccionada = posicion;
        
        $('#mnu_carta').addClass('marco_carta');
        $('#mnu_carta').html('<div id="carta_seleccionada" class="carta"></div>');
        $('#carta_seleccionada').html($('.cartaTablero[posicion="' + posicion + '"]').html());
        
        miTarjeta = $('.cartaTablero[posicion="' + posicion + '"]').attr('id');
    }
    
    function aceptarPartida() {
    	if (posicionSeleccionada != null) {
			var params = {
				id : juego.id,
				card_id : $('.cartaTablero[posicion="' + posicionSeleccionada + '"]').attr('id'),
				card_name : $('.cartaTablero[posicion="' + posicionSeleccionada + '"]').find('.nombre').attr('nombre'),
				card_type : $('.cartaTablero[posicion="' + posicionSeleccionada + '"]').attr('tipo'),
				card_facebook_id : $('.cartaTablero[posicion="' + posicionSeleccionada + '"]').attr('id')
			};
			aceptarJuego(params,
				function(response, textStatus, jqXHR) {
					if (response && response.id && response.id > 0) {
						muestraBotones();
						alert('Tu carta ha sido guardada y ahora es tu turno de preguntar o adivinar.');
					} else {
						alert('Tu partida no se pudo guardar correctamente. Favor de intentar nuevamente.');
					}
				},
				function(jqXHR, textStatus, errorThrown) {
					alert('Tu partida no se pudo guardar correctamente. Favor de intentar nuevamente.');
				});
    	} else {
            alert('Debes seleccionar tu carta para continuar.');
        }
    }
</script>
<div id="juego">
	<div class="izquierda">
		<div id="menu">
			<div id="mnu_carta"></div>
            <div id="mnu_preguntas">
            	<img id="fondo_preguntas" src="img/ju_preguntas.png" />
            	<div id="total_preguntas"></div>
            </div>
            <div id="mnu_botones">
			</div>
		</div>
	</div>
	<div class="derecha">
		<div id="cuadro_negro">
		</div>
	</div>
</div>